<template>
    <scheme-tab
        :tabs="tabs"
        :active.sync="activeTab"
    >
        <section v-show="activeTab === 'edit'">
            <scheme-header />
            <single-scheme
                ref="singleSchemeRef"
                :scheme="renderResponseParam"
                :minus-disable="true"
                @update="handleUpdate"
            />
        </section>
        <monaco
            v-show="activeTab === 'response'"
            :value="responseString"
            @change="handleResponseChange"
        />
    </scheme-tab>
</template>

<script>
    import {
        defineComponent,
        ref,
        onMounted,
        getCurrentInstance,
        watch
    } from '@vue/composition-api'
    import SchemeTab from '../common/scheme-tab'
    import SchemeHeader from '../common/scheme-header'
    import SingleScheme from '../common/single-scheme'
    import Monaco from '@/components/monaco'
    import {
        getDefaultApiEditScheme,
        parseScheme2Value,
        parseValue2Scheme,
        API_PARAM_TYPES
    } from 'shared/api'

    export default defineComponent({
        components: {
            SchemeTab,
            SchemeHeader,
            SingleScheme,
            Monaco
        },

        props: {
            params: Object,
            response: [Object, Array, String, Number]
        },

        setup (props, { emit }) {
            const tabs = [
                { name: 'response', label: '响应示例' },
                { name: 'edit', label: '响应结果字段提取' }
            ]
            const currentInstance = getCurrentInstance()
            const activeTab = ref('response')
            const renderResponseParam = ref({})
            const responseString = ref('')

            const handleUpdate = (param) => {
                renderResponseParam.value = param
                emit('change', renderResponseParam.value)
            }

            const handleResponseChange = (value) => {
                try {
                    responseString.value = value
                    const Fn = Function
                    const responseValue = new Fn(`return ${value}`)()
                    const responseParam = parseValue2Scheme(responseValue)
                    handleUpdate(responseParam)
                } catch (error) {
                    console.error(`输入有误，请重新输入：${error.message}`)
                }
            }

            const validate = () => {
                return currentInstance
                    .proxy
                    .$refs
                    .singleSchemeRef
                    .validate()
                    .then(() => renderResponseParam.value)
            }

            watch(
                () => props.response,
                () => {
                    handleResponseChange(JSON.stringify(props.response, null, 4))
                }
            )

            onMounted(() => {
                // 设置 params
                renderResponseParam.value = props.params
                // 默认显示 root
                if (renderResponseParam.value.name === undefined) {
                    renderResponseParam.value = getDefaultApiEditScheme({
                        name: 'root',
                        type: API_PARAM_TYPES.OBJECT.VAL,
                        value: API_PARAM_TYPES.OBJECT.DEFAULT,
                        plusBrotherDisable: true
                    })
                }
                // 设置 monaco 内容
                responseString.value = JSON.stringify(parseScheme2Value(renderResponseParam.value), null, 4)
            })

            return {
                tabs,
                activeTab,
                renderResponseParam,
                responseString,
                handleUpdate,
                validate,
                handleResponseChange
            }
        }
    })

</script>

<style lang="postcss" scoped>
    
</style>
